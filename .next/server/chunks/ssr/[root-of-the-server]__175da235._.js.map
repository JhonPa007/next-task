{"version":3,"sources":["../../../../src/lib/prisma.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/server-reference.ts","../../../../node_modules/next/src/build/webpack/loaders/next-flight-loader/action-validate.ts","../../../../src/app/actions/workspace.ts","../../../../src/components/layout/SidebarLayout.tsx/__nextjs-internal-proxy.mjs","../../../../src/components/ai/FloatingChatbot.tsx/__nextjs-internal-proxy.mjs","../../../../src/components/theme/ThemeProvider.tsx/__nextjs-internal-proxy.mjs","../../../../src/app/layout.tsx"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\n\r\nconst globalForPrisma = globalThis as unknown as {\r\n    prisma: PrismaClient | undefined;\r\n};\r\n\r\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\r\n","/* eslint-disable import/no-extraneous-dependencies */\nexport { registerServerReference } from 'react-server-dom-webpack/server'\n","// This function ensures that all the exported values are valid server actions,\n// during the runtime. By definition all actions are required to be async\n// functions, but here we can only check that they are functions.\nexport function ensureServerEntryExports(actions: any[]) {\n  for (let i = 0; i < actions.length; i++) {\n    const action = actions[i]\n    if (typeof action !== 'function') {\n      throw new Error(\n        `A \"use server\" file can only export async functions, found ${typeof action}.\\nRead more: https://nextjs.org/docs/messages/invalid-use-server-value`\n      )\n    }\n  }\n}\n","'use server';\r\n\r\nimport { prisma } from '@/lib/prisma';\r\nimport { revalidatePath } from 'next/cache';\r\n\r\n// Fetch all workspaces for the Sidebar\r\nexport async function getWorkspaces() {\r\n    try {\r\n        const workspaces = await prisma.workspace.findMany({\r\n            orderBy: { createdAt: 'desc' }\r\n        });\r\n        return workspaces;\r\n    } catch (error) {\r\n        console.error('Error fetching workspaces:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Create a new Workspace\r\nexport async function createWorkspace(name: string) {\r\n    try {\r\n        const ws = await prisma.workspace.create({\r\n            data: {\r\n                name,\r\n                // Mocking a user connection since there is no Auth yet\r\n                // members: { create: { userId: 'mock-user-id', role: 'ADMIN' } }\r\n            }\r\n        });\r\n\r\n        revalidatePath('/');\r\n        return ws;\r\n    } catch (error) {\r\n        console.error('Error creating workspace:', error);\r\n        throw new Error('Could not create workspace');\r\n    }\r\n}\r\n\r\n// Update Workspace Name\r\nexport async function updateWorkspace(id: string, name: string) {\r\n    try {\r\n        const ws = await prisma.workspace.update({\r\n            where: { id },\r\n            data: { name }\r\n        });\r\n        revalidatePath('/');\r\n        return ws;\r\n    } catch (error) {\r\n        console.error('Error updating workspace:', error);\r\n        throw new Error('Could not update workspace');\r\n    }\r\n}\r\n\r\n// Delete Workspace\r\nexport async function deleteWorkspace(id: string) {\r\n    try {\r\n        await prisma.workspace.delete({\r\n            where: { id }\r\n        });\r\n        revalidatePath('/');\r\n        return true;\r\n    } catch (error) {\r\n        console.error('Error deleting workspace:', error);\r\n        throw new Error('Could not delete workspace');\r\n    }\r\n}\r\n\r\n// Get Workspace Members\r\nexport async function getWorkspaceMembers(workspaceId: string) {\r\n    try {\r\n        // Obtenemos los miembros formales\r\n        const members = await prisma.workspaceMember.findMany({\r\n            where: { workspaceId },\r\n            include: { user: true }\r\n        });\r\n\r\n        const { getCurrentUser } = await import('@/app/actions/user');\r\n        const currentUser = await getCurrentUser();\r\n\r\n        let users = members.map(m => m.user);\r\n\r\n        // Siempre incluimos al usuario personal (admin) para que pueda asignarse a sí mismo en los workspaces\r\n        if (currentUser && !users.find(u => u.id === currentUser.id)) {\r\n            users.push(currentUser);\r\n        }\r\n\r\n        if (users.length > 0) {\r\n            return users;\r\n        }\r\n\r\n        // Fallback: Si no hay miembros formalmente unidos, devolver todos los usuarios \r\n        // para propósitos de prueba de la UI.\r\n        const allUsers = await prisma.user.findMany();\r\n\r\n        // Si no hay usuarios en absoluto, creamos uno mock para que la UI funcione\r\n        if (allUsers.length === 0) {\r\n            const mockUser = await prisma.user.create({\r\n                data: {\r\n                    email: `mock-${Date.now()}@example.com`,\r\n                    name: 'Usuario de Prueba'\r\n                }\r\n            });\r\n            return [mockUser];\r\n        }\r\n\r\n        return allUsers;\r\n\r\n    } catch (error) {\r\n        console.error('Error fetching workspace members:', error);\r\n        return [];\r\n    }\r\n}\r\n\r\n// Invite User to Workspace\r\nexport async function inviteUserToWorkspace(workspaceId: string, email: string) {\r\n    try {\r\n        const lowerEmail = email.toLowerCase().trim();\r\n        if (!lowerEmail) {\r\n            return { error: 'El email no puede estar vacío.' };\r\n        }\r\n\r\n        // 1. Buscar si el usuario existe\r\n        let user = await prisma.user.findUnique({\r\n            where: { email: lowerEmail }\r\n        });\r\n\r\n        // 2. Si no existe, lo creamos on-the-fly (ghost user base)\r\n        if (!user) {\r\n            user = await prisma.user.create({\r\n                data: {\r\n                    email: lowerEmail,\r\n                    name: lowerEmail.split('@')[0], // Nombre genérico basado en el email\r\n                }\r\n            });\r\n        }\r\n\r\n        // 3. Verificar si ya es miembro de este workspace\r\n        const existingMember = await prisma.workspaceMember.findUnique({\r\n            where: {\r\n                userId_workspaceId: {\r\n                    userId: user.id,\r\n                    workspaceId: workspaceId\r\n                }\r\n            }\r\n        });\r\n\r\n        if (existingMember) {\r\n            return { error: 'Este usuario ya es miembro del Workspace.' };\r\n        }\r\n\r\n        // 4. Añadir como miembro\r\n        await prisma.workspaceMember.create({\r\n            data: {\r\n                userId: user.id,\r\n                workspaceId,\r\n                role: 'MEMBER'\r\n            }\r\n        });\r\n\r\n        revalidatePath(`/workspace/${workspaceId}`);\r\n        return { success: true, message: `Usuario ${lowerEmail} añadido correctamente.` };\r\n\r\n    } catch (error) {\r\n        console.error('Error in inviteUserToWorkspace:', error);\r\n        return { error: 'Hubo un error inesperado al invitar al usuario.' };\r\n    }\r\n}\r\n\r\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/layout/SidebarLayout.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/layout/SidebarLayout.tsx\",\n    \"default\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/ai/FloatingChatbot.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/ai/FloatingChatbot.tsx\",\n    \"default\",\n);\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport const ThemeProvider = registerClientReference(\n    function() { throw new Error(\"Attempted to call ThemeProvider() from the server but ThemeProvider is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/theme/ThemeProvider.tsx\",\n    \"ThemeProvider\",\n);\nexport const useTheme = registerClientReference(\n    function() { throw new Error(\"Attempted to call useTheme() from the server but useTheme is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/theme/ThemeProvider.tsx\",\n    \"useTheme\",\n);\n","import type { Metadata } from \"next\";\r\nimport SidebarLayout from \"@/components/layout/SidebarLayout\";\r\nimport FloatingChatbot from \"@/components/ai/FloatingChatbot\";\r\nimport { ThemeProvider } from \"@/components/theme/ThemeProvider\";\r\nimport { getWorkspaces } from '@/app/actions/workspace';\r\nimport \"./globals.css\";\r\n\r\nexport const metadata: Metadata = {\r\n    title: \"NextTask - Gestión de Proyectos\",\r\n    description: \"Plataforma integral de gestión de proyectos y workspaces.\",\r\n};\r\n\r\nexport default async function RootLayout({\r\n    children,\r\n}: Readonly<{\r\n    children: React.ReactNode;\r\n}>) {\r\n    let workspaces: any[] = [];\r\n    try {\r\n        workspaces = await getWorkspaces();\r\n    } catch (e) {\r\n        console.warn(\"DB not connected yet, skipping workspace fetch in layout\");\r\n    }\r\n\r\n    return (\r\n        <html lang=\"es\" suppressHydrationWarning>\r\n            <body suppressHydrationWarning>\r\n                <ThemeProvider>\r\n                    <SidebarLayout initialWorkspaces={workspaces}>\r\n                        {children}\r\n                    </SidebarLayout>\r\n                    <FloatingChatbot />\r\n                </ThemeProvider>\r\n            </body>\r\n        </html>\r\n    );\r\n}\r\n"],"names":["registerServerReference","ensureServerEntryExports","actions","i","length","action","Error"],"mappings":"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","ignoreList":[1,2,4,5,6]}